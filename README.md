# laravel-connector

Framework‑agnostic TypeScript client for Laravel APIs with built‑in Sanctum CSRF support. It provides a tiny wrapper around fetch with sensible defaults, typed responses, query params, and helpers for common HTTP verbs.

## Overview
- Works in browsers (and Node 18+ with built‑in fetch)
- Automatically retrieves and sends Laravel Sanctum CSRF cookies for state‑changing requests (POST, PUT, PATCH, DELETE)
- Simple API: Api class and createApi factory
- ESM package with TypeScript types
- Tested with Vitest + happy-dom

## Stack
- Language: TypeScript (ESM)
- Build: TypeScript (tsc)
- Tests: Vitest with happy-dom and V8 coverage
- Package manager: npm (package-lock.json present)
- Entry points (package.json):
  - main: dist/index.js
  - types: dist/index.d.ts
  - exports: { ".": { import: "./dist/index.js", types: "./dist/index.d.ts" } }

## Requirements
- Node.js 18+ (for global fetch in tests and development). For older Node versions, use a fetch/polyfill (TODO: document recommended polyfill if Node < 18 is required).
- npm 9+ recommended

Runtime environments:
- Browser: any modern browser. The library reads the XSRF-TOKEN cookie set by Laravel Sanctum.
- Node: works with global fetch (Node 18+). CSRF cookie behavior depends on cookie handling in your environment; typically this library is intended for browser use when working with Sanctum.

## Installation
Install via npm into your application or library:

```
npm install laravel-connector
```

If working from this repository (local development):

```
npm ci
```

## Usage
Create a client once and reuse it across your app:

```ts
import { createApi } from 'laravel-connector'

const api = createApi({
  baseUrl: 'https://api.example.com',
  withCredentials: true, // default true; sends cookies for cross-site requests
  headers: { 'X-Custom-Header': 'demo' }
})

// GET with query params
type User = { id: number; name: string }
const res = await api.get<User[]>('/users', { params: { page: 1 } })
if (res.data) {
  console.log(res.data)
}

// POST automatically fetches CSRF cookie from /sanctum/csrf-cookie and sends X-XSRF-TOKEN
const created = await api.post<User>('/users', { name: 'Renato' })
if (created.errors) {
  console.error(created.errors)
}

// Update default headers later
api.setDefaultHeaders({ Authorization: 'Bearer <token>' })

// Clear cached CSRF token if needed (e.g., on logout)
api.clearCsrfToken()
```

API surface:
- createApi(config): Api
- new Api(config)
- api.request(endpoint, options)
- api.get(endpoint, options)
- api.post(endpoint, body?, options)
- api.put(endpoint, body?, options)
- api.patch(endpoint, body?, options)
- api.delete(endpoint, options)
- api.setDefaultHeaders(headers)
- api.clearCsrfToken()

Types:
- Config: { baseUrl: string; withCredentials?: boolean; headers?: Record<string, string> }
- Response<T>: { data: T | null; errors: any; loading: boolean; status: number | null }
- RequestOptions extends RequestInit with params?: Record<string, any>

Notes on CSRF and Sanctum:
- For non-GET methods, the client will call `${baseUrl}/sanctum/csrf-cookie` once and cache XSRF-TOKEN from document.cookie, then send it via X-XSRF-TOKEN header.
- Ensure your Laravel backend is configured for Sanctum and sets the XSRF-TOKEN cookie for your frontend domain. See Laravel Sanctum docs.

## Scripts
Available npm scripts (see package.json):
- build: tsc
- dev: tsc --watch
- test: vitest
- test:ui: vitest --ui
- test:run: vitest run
- test:coverage: vitest run --coverage
- prepublishOnly: npm run build

## Development
Build once:
```
npm run build
```

Watch mode for local development (rebuild on change):
```
npm run dev
```

Run tests:
```
npm test
```

Open Vitest UI:
```
npm run test:ui
```

Coverage report (text, json, html in coverage/):
```
npm run test:coverage
```

## Environment Variables
No required environment variables for the library itself.
- TODO: If publishing example apps or demos, document any env vars they need here.

## Project Structure
```
/ (repo root)
├─ src/                 # TypeScript source
│  ├─ api.ts            # Api class and core logic
│  ├─ index.ts          # Package entry: re-exports Api and types
│  └─ types/index.d.ts  # Public types declarations
├─ tests/               # Vitest specs and setup
│  ├─ __mocks__/fetch.ts
│  ├─ api.test.ts
│  └─ setup.ts
├─ dist/                # Compiled output (generated by tsc)
├─ vitest.config.ts     # Test runner config
├─ tsconfig.json        # TypeScript compiler options
├─ package.json         # Package metadata, scripts, exports
├─ package-lock.json
└─ LICENSE              # MIT license (see below)
```

## Testing
- Test runner: Vitest
- DOM environment: happy-dom
- Coverage: V8 provider (text, json, html). See coverage/ after running test:coverage.

Commands:
```
npm test
npm run test:run
npm run test:ui
npm run test:coverage
```

## Publishing
This package is configured for ESM and TypeScript types. The prepublishOnly script builds the project:
```
npm publish
```
Note: Ensure dist/ is up to date and that README.md and LICENSE are present (both are included via the files field).

## License
MIT © rdehnhardt. See LICENSE for details.

## Changelog / Versioning
- Current version: 1.0.0 (see package.json)
- TODO: Add CHANGELOG.md if you plan to maintain release notes.

## Contributing
- Fork and create feature branches from main
- Add tests for changes when reasonable
- Run lint/format if/when introduced (TODO)
- Open a pull request with a clear description
